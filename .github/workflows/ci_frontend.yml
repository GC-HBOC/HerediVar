name: ci frontend

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:

  test_annotation_service:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
            MYSQL_ALLOW_EMPTY_PASSWORD: yes
            MYSQL_USER: test_user
            MYSQL_PASSWORD: password
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v3


      - name: set environment variables
        run: |
          echo "ngs-bits-version=2022_10--py310hf1a0324_1" >> $GITHUB_ENV
          echo "samtools-version=1.11" >> $GITHUB_ENV
          echo "htslib-version=1.16" >> $GITHUB_ENV
        # echo "job-name=test_annotation_service" >> $GITHUB_ENV
      

      # install os dependencies
      - name: update OS repositories
        run: sudo apt-get update

      - name: install OS dependencies
        run: sudo apt-get install autoconf automake make gcc perl zlib1g-dev libbz2-dev liblzma-dev libcurl4-gnutls-dev libssl-dev libncurses5-dev libncursesw5-dev

      - name: install OS dependencies 2
        run: sudo apt-get install g++ qt5-default libqt5xmlpatterns5-dev libqt5sql5-mysql libcurl4 libcurl4-openssl-dev


      # setup python
      - name: Set up Python 3.6.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.6.9'  # use 3.x to use the most up-to-date python3 version
          architecture: 'x64' # Optional - x64 or x86 architecture, defaults to x64
      - uses: actions/cache@v3 # cache the python environment to speed up tests
        id: cache-python-modules
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('requirements.txt') }}
      - if: ${{ steps.cache-python-modules.outputs.cache-hit != 'true' }}
        name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install wheel setuptools
          python3 -m pip install --upgrade setuptools wheel
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi


      # install tools dependencies
      - name: cache samtools
        id: cache-samtools
        uses: actions/cache@v3
        env:
          cache-name: cache-samtools
        with:
          path: samtools-${{ env.samtools-version }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.samtools-version }}
      - if: ${{ steps.cache-samtools.outputs.cache-hit != 'true' }}
        name: install samtools
        run: |
          sudo wget -q https://github.com/samtools/samtools/releases/download/${{ env.samtools-version }}/samtools-${{ env.samtools-version }}.tar.bz2
          sudo tar xjf samtools-${{ env.samtools-version }}.tar.bz2
          sudo rm samtools-${{ env.samtools-version }}.tar.bz2
          cd samtools-${{ env.samtools-version }}
          sudo make

      - name: cache htslib
        id: cache-htslib
        uses: actions/cache@v3
        env:
          cache-name: cache-htslib
        with:
          path: htslib-${{ env.htslib-version }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.htslib-version }}
      - if: ${{ steps.cache-htslib.outputs.cache-hit != 'true' }}
        name: install htslib
        run: |
          sudo wget -q https://github.com/samtools/htslib/releases/download/${{ env.htslib-version }}/htslib-${{ env.htslib-version }}.tar.bz2
          sudo tar -vxjf htslib-${{ env.htslib-version }}.tar.bz2
          cd htslib-${{ env.htslib-version }}
          sudo make



      - name: cache ngs-bits
        id: cache-ngs-bits
        uses: actions/cache@v3
        env:
          cache-name: cache-ngs-bits
        with:
          path: ngs-bits-${{ env.ngs-bits-version }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.ngs-bits-version }}
      - if: ${{ steps.cache-ngs-bits.outputs.cache-hit != 'true' }}
        name: install ngs-bits local
        run: |
          git clone --recursive https://github.com/imgag/ngs-bits.git
          mv ngs-bits ngs-bits-${{ env.ngs-bits-version }}
          cd ngs-bits-${{ env.ngs-bits-version }}
          make build_3rdparty build_libs_release build_tools_release


      - name: update environment variables
        run: |
          echo "$GITHUB_WORKSPACE/samtools-${{ env.samtools-version }}" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/htslib-${{ env.htslib-version }}" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/ngs-bits-${{ env.ngs-bits-version }}/bin" >> $GITHUB_PATH
          cat $GITHUB_PATH
          ReadQC --help


      # download genomes
      - name: download grch38
        run: |  
          wget -q ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/001/405/GCA_000001405.15_GRCh38/seqs_for_alignment_pipelines.ucsc_ids/GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz
          (gunzip -c GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz |  sed -r 's/>chrM/>chrMT/g' > GRCh38.fa) || true
          rm GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz
          samtools faidx GRCh38.fa


      # install ngs-bits
      - name: install ngs-bits
        run: docker pull quay.io/biocontainers/ngs-bits:${{ env.ngs-bits-version }}

      - name: start ngs-bits container
        run: |
          docker images
          docker run -d -v /tmp:/tmp -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE -it quay.io/biocontainers/ngs-bits:${{ env.ngs-bits-version }} /bin/bash > ngs-bits-container.txt
          docker ps -a

      - name: test ngs-bits
        run: |
          ngsbitscontainer=$(cat ngs-bits-container.txt)
          docker exec $ngsbitscontainer ReadQC --help


      # init dbs
      - name: Init heredivar database
        run: |
          sudo apt-get install -y mysql-client
          export MOST_RECENT_DUMP_DATE=$(cat src/tools/database_dumper/most_recent_dump.txt)
          gunzip src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql.gz
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/frontend_celery/tests/data/heredivar_test_data.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db -e "SHOW TABLES"

      # write settings.ini
      - name: prepare settings
        run: |
          echo "DB_HOST=0.0.0.0" > src/common/settings.ini
          echo "DB_NAME=test_db" >> src/common/settings.ini

          echo "DB_USER=test_user" >> src/common/settings.ini
          echo "DB_USER_PW=password" >> src/common/settings.ini
          echo "DB_SUPER_USER=test_user" >> src/common/settings.ini
          echo "DB_SUPER_USER_PW=password" >> src/common/settings.ini
          echo "DB_ANNOTATION_USER=test_user" >> src/common/settings.ini
          echo "DB_ANNOTATION_USER_PW=password" >> src/common/settings.ini


      # run tests
      - name: test annotation service
        run: |
          echo $PATH
          export NGSBITS_CONTAINER_ID=$(cat ngs-bits-container.txt)

          chmod 755 src/annotation_service/tests/run_tests.sh
          src/annotation_service/tests/run_tests.sh
        env:
          WEBAPP_ENV: githubtest
        shell: bash



  test_frontend:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
            MYSQL_ALLOW_EMPTY_PASSWORD: yes
            MYSQL_USER: test_user
            MYSQL_PASSWORD: password
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # download repository
      - uses: actions/checkout@v3

      - name: set versions
        run: |
          echo "ngs-bits-version=2022_10--py310hf1a0324_1" >> $GITHUB_ENV
          echo "samtools-version=1.11" >> $GITHUB_ENV
          echo "htslib-version=1.16" >> $GITHUB_ENV

      # install os dependencies
      - name: update OS repositories
        run: sudo apt-get update

      - name: install OS dependencies
        run: sudo apt-get install autoconf automake make gcc perl zlib1g-dev libbz2-dev liblzma-dev libcurl4-gnutls-dev libssl-dev libncurses5-dev libncursesw5-dev

      # init dbs
      - name: Verify MySQL connection from container 
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
          export MOST_RECENT_DUMP_DATE=$(cat src/tools/database_dumper/most_recent_dump.txt)
          gunzip src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql.gz
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/frontend_celery/tests/data/heredivar_test_data.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db -e "SHOW TABLES"

      - name: Init NGSD
        run: |
          mysql --host 0.0.0.0 -uroot -ppassword --port 3306 -e "CREATE DATABASE IF NOT EXISTS ngsd;"
          mysql --host 0.0.0.0 -uroot -ppassword --port 3306 -e "SHOW DATABASES LIKE 'ngsd';"
          mysql --host 0.0.0.0 -uroot -ppassword --port 3306 ngsd < src/frontend_celery/tests/data/ngsd_test_data.sql
          mysql --host 0.0.0.0 -uroot -ppassword --port 3306 -e "SHOW TABLES FROM ngsd"


      # setup ngs-bits
      - name: install ngs-bits
        run: docker pull quay.io/biocontainers/ngs-bits:${{ env.ngs-bits-version }}

      - name: start ngs-bits container
        run: |
          docker images
          docker run -d -v /tmp:/tmp -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE  --network="host" -it quay.io/biocontainers/ngs-bits:${{ env.ngs-bits-version }} /bin/bash > ngs-bits-container.txt
          docker ps -a

      - name: test ngs-bits
        run: |
          ngsbitscontainer=$(cat ngs-bits-container.txt)
          docker exec $ngsbitscontainer ReadQC --help

      - name: Connect ngs-bits with ngsd
        run: |
          ngsbitscontainer=$(cat ngs-bits-container.txt)
          echo "ngsd_host = \"0.0.0.0\"" > settings.ini
          echo "ngsd_port = 3306" >> settings.ini
          echo "ngsd_name = \"ngsd\"" >> settings.ini
          echo "ngsd_user = \"root\"" >> settings.ini
          echo "ngsd_pass = \"password\"" >> settings.ini
          docker cp settings.ini $ngsbitscontainer:/usr/local/bin
          docker exec $ngsbitscontainer cat /usr/local/bin/settings.ini
        #a6b92e07401f9f9df6e471043c7634d3b38f59307c3bfb2c5e62aa801503ae36

      
      # build python
      - name: Set up Python 3.6.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.6.9'  # use 3.x to use the most up-to-date python3 version
          architecture: 'x64' # Optional - x64 or x86 architecture, defaults to x64
      - uses: actions/cache@v3 # cache the python environment to speed up tests
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('requirements.txt') }}
      - if: ${{ steps.cache-python-modules.outputs.cache-hit != 'true' }}
        name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install wheel setuptools
          python3 -m pip install --upgrade setuptools wheel
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi




      # install tools dependencies (used for crossmap)
      - name: cache samtools
        id: cache-samtools
        uses: actions/cache@v3
        env:
          cache-name: cache-samtools
        with:
          path: samtools-${{ env.samtools-version }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.samtools-version }}
      - if: ${{ steps.cache-samtools.outputs.cache-hit != 'true' }}
        name: install samtools
        run: |
          sudo wget -q https://github.com/samtools/samtools/releases/download/${{ env.samtools-version }}/samtools-${{ env.samtools-version }}.tar.bz2
          sudo tar xjf samtools-${{ env.samtools-version }}.tar.bz2
          sudo rm samtools-${{ env.samtools-version }}.tar.bz2
          cd samtools-${{ env.samtools-version }}
          sudo make

      - name: cache htslib
        id: cache-htslib
        uses: actions/cache@v3
        env:
          cache-name: cache-htslib
        with:
          path: htslib-${{ env.htslib-version }}
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ env.htslib-version }}
      - if: ${{ steps.cache-htslib.outputs.cache-hit != 'true' }}
        name: install htslib
        run: |
          sudo wget -q https://github.com/samtools/htslib/releases/download/${{ env.htslib-version }}/htslib-${{ env.htslib-version }}.tar.bz2
          sudo tar -vxjf htslib-${{ env.htslib-version }}.tar.bz2
          cd htslib-${{ env.htslib-version }}
          sudo make

      - name: update environment variables
        run: |
          echo "$GITHUB_WORKSPACE/samtools-${{ env.samtools-version }}" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/htslib-${{ env.htslib-version }}" >> $GITHUB_PATH


      # download genomes
      - name: download grch37
        run: |
          wget -q ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/reference/phase2_reference_assembly_sequence/hs37d5.fa.gz
          (gunzip -c hs37d5.fa.gz | sed -r 's/>/>chr/g' > GRCh37.fa) || true
          rm hs37d5.fa.gz
          samtools faidx GRCh37.fa

      - name: download grch38
        run: |  
          wget -q ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/001/405/GCA_000001405.15_GRCh38/seqs_for_alignment_pipelines.ucsc_ids/GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz
          (gunzip -c GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz |  sed -r 's/>chrM/>chrMT/g' > GRCh38.fa) || true
          rm GCA_000001405.15_GRCh38_no_alt_plus_hs38d1_analysis_set.fna.gz
          samtools faidx GRCh38.fa

      - name: download chainfile
        run: |
          wget http://hgdownload.soe.ucsc.edu/goldenPath/hg19/liftOver/hg19ToHg38.over.chain.gz
          (gunzip -c hg19ToHg38.over.chain.gz | sed -r 's/chrM/chrMT/g' | bgzip > hg19ToHg38.fixed.over.chain.gz) || true
          rm hg19ToHg38.over.chain.gz


      # setup keycloak
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: 11
      - name: Prepare Keycloak
        run: |
          chmod 755 src/frontend_celery/tests/script/prepare_keycloak.sh
          src/frontend_celery/tests/script/prepare_keycloak.sh

      - name: Start Keycloak
        run: |
          chmod 755 src/frontend_celery/tests/script/start_keycloak_for_tests.sh
          src/frontend_celery/tests/script/start_keycloak_for_tests.sh


      # write settings.ini
      - name: prepare settings
        run: |
          echo "DB_HOST=0.0.0.0" > src/common/settings.ini
          echo "DB_NAME=test_db" >> src/common/settings.ini

          echo "DB_USER=test_user" >> src/common/settings.ini
          echo "DB_USER_PW=password" >> src/common/settings.ini
          echo "DB_SUPER_USER=test_user" >> src/common/settings.ini
          echo "DB_SUPER_USER_PW=password" >> src/common/settings.ini
          echo "DB_ANNOTATION_USER=test_user" >> src/common/settings.ini
          echo "DB_ANNOTATION_USER_PW=password" >> src/common/settings.ini


      # run tests
      - name: run tests
        run: |
          export NGSBITS_CONTAINER_ID=$(cat ngs-bits-container.txt)

          chmod 755 src/frontend_celery/tests/script/run_tests.sh
          src/frontend_celery/tests/script/run_tests.sh
        ##### !secrets are loaded from github: https://github.com/Azure/actions-workflow-samples/blob/master/assets/create-secrets-for-GitHub-workflows.md
        env:
          WEBAPP_ENV: githubtest
          FLASK_SECRET_KEY: The_testing_key
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          CLINVAR_API_KEY: ${{ secrets.CLINVAR_API_KEY }}
        shell: bash

      

      #- name: Lint with flake8
      #  run: |
      #    # stop the build if there are Python syntax errors or undefined names
      #    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      #    # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
      #    flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      #- uses: conda-incubator/setup-miniconda@v2
      #  with:
      #    python-version: 3.6.9
      #    auto-activate-base: false
      #    channels: defaults,conda-forge,bioconda


      #- name: test install conda
      #  run: |
      #    conda install flake8
      #    conda list
      #    conda info
        
      #- name: install ngs-bits
      #  run: conda install ngs-bits

      #- name: install perl
      #  uses: shogo82148/actions-setup-perl@v1
      #  with:
      #    perl-version: '5.34'

      #- name: install vep
      #  run: src/tools/download_tools_vep.sh

      #- name: install vep
      #  run: docker pull ensemblorg/ensembl-vep:release_104.3
      
      #- name: start vep container
      #  run: |
      #    docker images
      #    docker run -d -it 43bc9e0feefb /bin/bash > vep-container.txt
      #    docker ps -a
      
      #- name: install vep plugins
      #  run: |
      #    vepcontainer=$(cat vep-container.txt)
      #    docker exec $vepcontainer INSTALL.pl -a p --PLUGINS REVEL,CADD,MaxEntScan --NO_UPDATE --NO_BIOPERL --NO_TEST --NO_HTSLIB

      #    docker exec $vepcontainer cp /opt/vep/.vep/Plugins/REVEL.pm modules
      #    docker exec $vepcontainer cp /opt/vep/.vep/Plugins/CADD.pm modules
      #    docker exec $vepcontainer cp /opt/vep/.vep/Plugins/MaxEntScan.pm modules


      #- name: install maxentscan
      #  run: |
      #    vepcontainer=$(cat vep-container.txt)
      #    docker exec $vepcontainer mkdir -p MaxEntScan
      #    docker exec $vepcontainer wget http://hollywood.mit.edu/burgelab/maxent/download/fordownload.tar.gz MaxEntScan
      #    docker exec $vepcontainer tar xzf MaxEntScan/fordownload.tar.gz
      #    docker exec $vepcontainer mv MaxEntScan/fordownload/* .
      #    docker exec $vepcontainer rm -rf MaxEntScan/fordownload*
      #    docker exec $vepcontainer chmod -R 755 MaxEntScan
          
      #- name: test vep
      #  run: |
      #    vepcontainer=$(cat vep-container.txt)
      #    docker exec $vepcontainer ./vep --help



      
      # this step installs ngs-bits though miniconda
      # $CONDA is an environment variable pointing to the root of the miniconda directory
      #- name: prepare conda
      #  run: |
      #    $CONDA/bin/conda config --add channels conda-forge
      #    $CONDA/bin/conda config --add channels bioconda
      #    $CONDA/bin/conda config --add channels defaults
          

      #- name: install samtools
      #  run: |
      #    conda install -c bioconda samtools
      #    conda list
      #    conda info
      #    ls -l $CONDA/bin

      #- name: install ngs-bits
      #  run: |
      #    $CONDA/bin/conda install ngs-bits
      #    $CONDA/bin/ReadQC --help