name: ci frontend

on: [push]

jobs:

  test_frontend:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
            MYSQL_ALLOW_EMPTY_PASSWORD: yes
            MYSQL_USER: test_user
            MYSQL_PASSWORD: password
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      # download repository
      - uses: actions/checkout@v3

      #- uses: conda-incubator/setup-miniconda@v2
      #  with:
      #    python-version: 3.6.9
      #    auto-activate-base: false
      #    channels: defaults,conda-forge,bioconda


      #- name: test install conda
      #  run: |
      #    conda install flake8
      #    conda list
      #    conda info
        
      #- name: install ngs-bits
      #  run: conda install ngs-bits




      
      # this step installs ngs-bits though miniconda
      # $CONDA is an environment variable pointing to the root of the miniconda directory
      - name: prepare conda
        run: |
          $CONDA/bin/conda config --add channels conda-forge
          $CONDA/bin/conda config --add channels bioconda
          $CONDA/bin/conda config --add channels defaults
          

      - name: install samtools
        run: |
          conda install -c bioconda samtools
          conda list
          conda info
          ls -l $CONDA/bin

      - name: install ngs-bits
        run: |
          $CONDA/bin/conda install ngs-bits
          $CONDA/bin/ReadQC --help


      - name: Verify MySQL connection from container 
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
          export MOST_RECENT_DUMP_DATE=$(cat src/tools/database_dumper/most_recent_dump.txt)
          gunzip src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql.gz
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/tools/database_dumper/structure/structure-$MOST_RECENT_DUMP_DATE.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db < src/frontend_celery/tests/data/heredivar_test_data.sql
          mysql --host 0.0.0.0 -uroot -ppassword test_db -e "SHOW TABLES"


      # prepare keycloak
      - uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Prepare Keycloak
        run: |
          chmod 755 src/frontend_celery/tests/script/prepare_keycloak.sh
          src/frontend_celery/tests/script/prepare_keycloak.sh

      # start keycloak
      - name: Start Keycloak
        run: |
          chmod 755 src/frontend_celery/tests/script/start_keycloak_for_tests.sh
          src/frontend_celery/tests/script/start_keycloak_for_tests.sh


      # build python
      - name: Set up Python 3.6.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.6.9'  # use 3.x to use the most up-to-date python3 version
          architecture: 'x64' # Optional - x64 or x86 architecture, defaults to x64
      - uses: actions/cache@v2 # cache the python environment to speed up tests
        with:
          path: ${{ env.pythonLocation }}
          key: ${{ env.pythonLocation }}-${{ hashFiles('requirements.txt') }}
      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install wheel setuptools
          python3 -m pip install --upgrade setuptools wheel
          pip install pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      #- name: Lint with flake8
      #  run: |
      #    # stop the build if there are Python syntax errors or undefined names
      #    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      #    # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
      #    flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      



      # run tests
      - name: run tests
        run: |
          chmod 755 src/frontend_celery/tests/script/run_tests.sh
          src/frontend_celery/tests/script/run_tests.sh
        ##### !!!!!! REPLACE THIS with secrets that are loaded from github: https://github.com/Azure/actions-workflow-samples/blob/master/assets/create-secrets-for-GitHub-workflows.md
        env:
          WEBAPP_ENV: githubtest
          FLASK_SECRET_KEY: The_testing_key
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          CLINVAR_API_KEY: ${{ secrets.CLINVAR_API_KEY }}
        shell: bash