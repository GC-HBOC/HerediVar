{% extends 'variant/variant_base.html' %}


{% block status_bar %}
<meta id="annotation_status" data-annotation-status="{{ current_annotation_status[4] }}" data-celery-task-id="{{ current_annotation_status[7] }}">

<div class="d-flex align-items-center">
    <!-- status badges -->
    <div id="annotation_status_pills">
        {% if current_annotation_status is not none %}

            {% if current_annotation_status[4] == 'pending' %}
                <span class="badge rounded-pill bg-secondary" data-bs-toggle="tooltip" title="Annotation requested at {{ current_annotation_status[3] }}">Annotation requested, <br> refresh page to see if it is ready</span>
            {% endif %}
            {% if current_annotation_status[4] == 'success' %}
                <span class="badge rounded-pill bg-success" data-bs-toggle="tooltip" title="Most recent annotation finished at {{ current_annotation_status[5] }}">Annotation done</span>
            {% endif %}
            {% if current_annotation_status[4] == 'error' %}
                <span class="badge rounded-pill bg-danger" data-bs-toggle="tooltip" title="Most recent annotation finished at {{ current_annotation_status[5] }} with fatal error {{ current_annotation_status[6] }}">Annotation error</span>
            {% endif %}
            {% if current_annotation_status[4] == 'retry' %}
                <span class="badge rounded-pill bg-warning" data-bs-toggle="tooltip" title="Most recent annotation yielded an error: {{ current_annotation_status[6] }}. Retrying soon.">Retrying annotation</span>
            {% endif %}

        {% else %}
            <span class="badge rounded-pill bg-secondary" data-bs-toggle="tooltip" title="This variant was not annotated, yet.">No annotation</span>
        {% endif %}
    </div>
    <div class="ssl">
        {% if clinvar_submission is none %}
            <span class="badge rounded-pill bg-secondary" data-bs-toggle="tooltip" title="This variant was not yet submitted to ClinVar">no ClinVar submission</span>
        {% else %}
            {% set status = clinvar_submission[4] %}
            {% if status in ['processed'] %}
                <span class="badge rounded-pill bg-success" data-bs-toggle="tooltip" title="Most recent ClinVar submission finished at {{ clinvar_submission[6] }}">ClinVar success</span>
            {% endif %}
            {% if status in ['error'] %}
                <span class="badge rounded-pill bg-danger" data-bs-toggle="tooltip" title="Most recent ClinVar submission yielded an error at {{ clinvar_submission[6] }} with error message: {{ clinvar_submission[5] }}">ClinVar error</span>
            {% endif %}
            {% if status in ['submitted', 'processing'] %}
                <span class="badge rounded-pill bg-secondary" data-bs-toggle="tooltip" title="Most recent ClinVar submission last updated at {{ clinvar_submission[6] }}. Refresh page to see if it is ready.">ClinVar {{ status }}</span>
            {% endif %}
        {% endif %}
    </div>

    <!-- options dropdown -->
    <div class="dropdown ssl">
        <button class="btn btn-secondary" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
            </svg>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            {% if session.get('user') is not none and 'user' in session['user']['roles']%}
            <li>
                <button id="reannotate_button" type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#reannotate-modal">(Re-)Annotate</button>
            </li>
            <li>
                <a type="button" class="dropdown-item" href="{{url_for('variant_io.submit_assay', variant_id = variant.id)}}" 
                data-bs-toggle="tooltip"  title="Submit an assay report & score for this variant.">
                    Submit assay
                </a>
            </li>
            <li>
                <a id="classify_button" type="button" class="dropdown-item" href="{{url_for('variant.classify', variant_id = variant.id)}}" 
                data-bs-toggle="tooltip"  title="Submit a new variant classification or edit your previous classification(s).">
                    Classify
                </a>
            </li>
            <li>
                {% set disabled = '' %}
                {% set title = 'Submit the consensus classification of this variant to ClinVar.' %}
                {% if variant.get_recent_consensus_classification() is none %}
                    {% set disabled = 'disabled' %}
                    {% set title = 'Create a consensus classification before submitting to ClinVar.' %}
                {% endif %}
                {% if 'submitted' == clinvar_submission['status'] or 'processing' == clinvar_submission['status'] %}
                    {% set disabled = 'disabled' %}
                    {% set title = 'Wait for the current ClinVar submission to finish before submitting another one.' %}
                {% endif %}
                <div data-bs-toggle="tooltip" title="{{ title }}"> <!-- idk why, but putting the tooltip on the button does not show it when the button is disabled -->
                    <button data-href="{{url_for('variant_io.submit_clinvar', variant_id = variant.id)}}" type="button" class="dropdown-item" {% if disabled == 'disabled' %} disabled="disabled" {% endif %}>
                        Submit to ClinVar
                    </button>
                </div>
            </li>
            {% endif %}
            <li>
                <a id="vcf_export_button" type="button" class="dropdown-item" href="{{url_for('download.variant', variant_id = variant.id)}}" 
                data-bs-toggle="tooltip" title="Download this variant & all annotations as VCF.">
                    Export to VCF
                </a>
            </li>
            <li>
                <button class="dropdown-item" id="list_add_button" data-bs-toggle="modal" data-bs-target="#list-add-modal">Add to list</button>
            </li>
        </ul>
    </div>

</div>
{% endblock %}



{% block modals %}


<!-- reannotate confirmation panel (it is a bootstrap modal) -->
<div class="modal fade" id="reannotate-modal" tabindex="-1" aria-labelledby="reannotate-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reannotate-modal-label">Confirm (re-)annotation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure that you want to (re-)annotate this variant?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="reannotate-submit" type="button" class="btn btn-primary">Yes</button>
            </div>
        </div>
    </div>
</div>




<!-- reload page modal, because annotation is finished -->
<div class="modal fade" id="reload-modal" tabindex="-1" aria-labelledby="reload-modal-label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reload-modal-label">Annotation finished</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                The requested variant annotation is ready. <br> 
                Do you want to reload the page now to view the new annotations?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button id="reload-submit" type="button" class="btn btn-primary">Yes</button>
            </div>
        </div>
    </div>
</div>



<!-- modal for multiple variant to a list -->
{% set title = 'Select a list to add this variant to it. If a list is highlighted in blue the current variant is already in that list' %}
{% if lists | length == 0 %}
    {% set title = 'You do not have a variant list. Please navigate to the "my-lists" page to create one. The "my-lists" page can be found when clicking on your name at the top right corner of this page.' %}
{% endif %}
{{ macros.select_list_modal(lists,
                            'user.modify_list_content', 
                            {'variant_id':variant.id, 
                             'action':'add_to_list',
                             'next': url_for('variant.display', variant_id=variant.id)}, 
                            title) }}


{% endblock %}


{% block additional_tab_heads %}
<li class="nav-item" role="presentation">
    <button class="nav-link" id="igv-tab" data-bs-toggle="tab" data-bs-target="#igv" type="button" role="tab" aria-controls="igv" aria-selected="false">IGV</button>
</li>
{% endblock %}


{% block additional_tabs %}
<div class="tab-pane fade" id="igv" role="tabpanel" aria-labelledby="igv-tab">
    <div class="w-100 ssb">
        <div class="card noboarder_top">
            <div class="card-body">
                <h4 class="card-subcaption">IGV</h4>

                <p class="card-text">
                    <div id="igv-container"></div>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}


<!--
    - variant consequences nach preferred transcripts sortieren und badges (mane select, ....) anzeigen
    - gene page
    - genids durch gennamen ersetzen in variant consequence table
    - nobreak für bestimmte spalten
    ~ minimale seitenbreite angeben
    - beim variant import vcf check laufen lassen
    ~ variant import auch von hgvs möglich machen
    external links karte einfügen
    abbr beschreibungen der flags einfügen
    variant consequence table nach refseq / ensembl filtern (mit toggle)
    transcript table auf gene page einfügen
    refseq transcripts importieren + mapping table enst -> refseq
    - umbruch der last evaluated daten verhindern in clinvar submissions table
    - clinvar submissions standardmäßig nach last evaluated sortieren
    - wenn variante erfolgreich hochgeladen wurde soll der link gleich angezeigt werden in der flashed message

    - add positive feedback if variant was imported successfully
-->